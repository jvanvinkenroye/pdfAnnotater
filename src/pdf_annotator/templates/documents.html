{% extends "base.html" %}

{% block title %}Dokumente - PDF Annotator{% endblock %}

{% block nav %}
<a href="{{ url_for('upload.index') }}" class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
    Neues PDF hochladen
</a>
{% endblock %}

{% block content %}
<div class="documents-container">
    <h1>Ihre PDF-Dokumente</h1>
    <p class="subtitle">Wählen Sie ein Dokument aus, um es zu bearbeiten oder fortzufahren.</p>

    {% if documents %}
    <div class="table-container">
        <table class="documents-table" id="documents-table">
            <thead>
                <tr>
                    <th class="sortable" data-column="0">Dateiname <span class="sort-icon">⇅</span></th>
                    <th class="sortable" data-column="1">Vorname <span class="sort-icon">⇅</span></th>
                    <th class="sortable" data-column="2">Nachname <span class="sort-icon">⇅</span></th>
                    <th class="sortable" data-column="3">Titel <span class="sort-icon">⇅</span></th>
                    <th class="sortable" data-column="4">Jahr <span class="sort-icon">⇅</span></th>
                    <th class="sortable" data-column="5">Thema <span class="sort-icon">⇅</span></th>
                    <th class="sortable" data-column="6">Seiten <span class="sort-icon">⇅</span></th>
                    <th class="sortable" data-column="7">Hochgeladen <span class="sort-icon">⇅</span></th>
                    <th class="sortable" data-column="8">Zuletzt bearbeitet <span class="sort-icon">⇅</span></th>
                    <th>Aktionen</th>
                </tr>
            </thead>
            <tbody>
                {% for doc in documents %}
                <tr>
                    <td class="filename-cell">{{ doc.original_filename }}</td>
                    <td>{{ doc.first_name or '-' }}</td>
                    <td>{{ doc.last_name or '-' }}</td>
                    <td>{{ doc.title or '-' }}</td>
                    <td>{{ doc.year or '-' }}</td>
                    <td>{{ doc.subject or '-' }}</td>
                    <td class="center">{{ doc.page_count }}</td>
                    <td>{{ doc.upload_timestamp.strftime('%Y-%m-%d %H:%M') if doc.upload_timestamp else '-' }}</td>
                    <td>{{ doc.last_edited[:16] if doc.last_edited else '-' }}</td>
                    <td class="actions-cell">
                        <a href="{{ url_for('viewer.view_document', doc_id=doc.id) }}" class="btn btn-primary btn-sm" title="Dokument bearbeiten">
                            Öffnen
                        </a>
                        <button class="btn btn-secondary btn-sm btn-download" title="PDF ersetzen" onclick="replacePdfInList('{{ doc.id }}')">
                            Ersetzen
                        </button>
                        <a href="{{ url_for('export.download_original_pdf', doc_id=doc.id) }}" class="btn btn-secondary btn-sm btn-download" title="Original-PDF herunterladen">
                            PDF
                        </a>
                        <a href="{{ url_for('export.export_pdf', doc_id=doc.id) }}" class="btn btn-secondary btn-sm btn-download" title="Annotiertes PDF herunterladen" onclick="return downloadAnnotatedPdf(event, '{{ doc.id }}')">
                            Annotiert
                        </a>
                        <a href="{{ url_for('export.export_markdown', doc_id=doc.id) }}" class="btn btn-secondary btn-sm btn-download" title="Markdown-Notizen herunterladen" onclick="return downloadMarkdown(event, '{{ doc.id }}')">
                            MD
                        </a>
                        <button class="btn btn-danger btn-sm" title="Dokument löschen" onclick="deleteDocument('{{ doc.id }}', '{{ doc.original_filename }}')">
                            Löschen
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
        </svg>
        <h2>Noch keine Dokumente</h2>
        <p>Laden Sie Ihr erstes PDF hoch, um zu beginnen.</p>
        <a href="{{ url_for('upload.index') }}" class="btn btn-primary">
            Jetzt PDF hochladen
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<!-- Hidden file input for PDF replacement -->
<input type="file" id="replace-pdf-file-input" accept=".pdf" style="display: none;">

<script>
(function() {
    'use strict';

    const table = document.getElementById('documents-table');
    if (!table) return;

    const headers = table.querySelectorAll('th.sortable');
    let sortDirection = {}; // Track sort direction per column

    // PDF replacement state
    let currentReplacingDocId = null;
    const replacePdfFileInput = document.getElementById('replace-pdf-file-input');

    headers.forEach(header => {
        const columnIndex = parseInt(header.dataset.column);
        sortDirection[columnIndex] = 'asc';

        header.addEventListener('click', function() {
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            // Toggle sort direction
            sortDirection[columnIndex] = sortDirection[columnIndex] === 'asc' ? 'desc' : 'asc';

            // Remove active class from all headers
            headers.forEach(h => h.classList.remove('active-sort'));
            header.classList.add('active-sort');

            // Update sort icon
            headers.forEach(h => {
                const icon = h.querySelector('.sort-icon');
                if (icon) icon.textContent = '⇅';
            });
            const activeIcon = header.querySelector('.sort-icon');
            if (activeIcon) {
                activeIcon.textContent = sortDirection[columnIndex] === 'asc' ? '↑' : '↓';
            }

            // Sort rows
            rows.sort((rowA, rowB) => {
                const cellA = rowA.cells[columnIndex].textContent.trim();
                const cellB = rowB.cells[columnIndex].textContent.trim();

                // Handle empty values
                if (cellA === '-') return 1;
                if (cellB === '-') return -1;

                // Handle numeric columns (Seiten)
                if (columnIndex === 6) {
                    const numA = parseInt(cellA) || 0;
                    const numB = parseInt(cellB) || 0;
                    return sortDirection[columnIndex] === 'asc' ? numA - numB : numB - numA;
                }

                // Handle date columns (Hochgeladen, Zuletzt bearbeitet)
                if (columnIndex === 7 || columnIndex === 8) {
                    const dateA = new Date(cellA);
                    const dateB = new Date(cellB);
                    return sortDirection[columnIndex] === 'asc' ? dateA - dateB : dateB - dateA;
                }

                // String comparison for other columns
                const comparison = cellA.localeCompare(cellB, 'de');
                return sortDirection[columnIndex] === 'asc' ? comparison : -comparison;
            });

            // Re-append sorted rows
            rows.forEach(row => tbody.appendChild(row));
        });

        // Add hover effect
        header.style.cursor = 'pointer';
    });

    // Download functions for POST requests
    window.downloadAnnotatedPdf = function(event, docId) {
        event.preventDefault();
        downloadFile(`/export/pdf/${docId}`, 'POST');
        return false;
    };

    window.downloadMarkdown = function(event, docId) {
        event.preventDefault();
        downloadFile(`/export/markdown/${docId}`, 'POST');
        return false;
    };

    function downloadFile(url, method) {
        fetch(url, {
            method: method,
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Download failed');
                }

                // Extract filename from Content-Disposition header
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'download';
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                    if (filenameMatch && filenameMatch[1]) {
                        filename = filenameMatch[1].replace(/['"]/g, '');
                    }
                }

                return response.blob().then(blob => ({ blob, filename }));
            })
            .then(({ blob, filename }) => {
                // Create download link
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = downloadUrl;
                a.download = filename;
                document.body.appendChild(a);
                a.click();

                // Cleanup
                window.URL.revokeObjectURL(downloadUrl);
                document.body.removeChild(a);
            })
            .catch(error => {
                console.error('Error downloading file:', error);
                alert('Fehler beim Herunterladen der Datei');
            });
    }

    // PDF replacement function
    window.replacePdfInList = function(docId) {
        currentReplacingDocId = docId;
        replacePdfFileInput.click();
    };

    // Handle file selection for replacement
    replacePdfFileInput.addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (!file || !currentReplacingDocId) {
            return;
        }

        // Validate file type
        if (!file.name.toLowerCase().endsWith('.pdf')) {
            alert('Bitte wählen Sie eine PDF-Datei aus.');
            replacePdfFileInput.value = '';
            currentReplacingDocId = null;
            return;
        }

        // Validate file size (50 MB)
        const maxSize = 50 * 1024 * 1024;
        if (file.size > maxSize) {
            alert('Die Datei ist zu groß. Maximum: 50 MB');
            replacePdfFileInput.value = '';
            currentReplacingDocId = null;
            return;
        }

        // Confirm replacement
        if (!confirm('Möchten Sie wirklich das PDF ersetzen? Alle Notizen bleiben erhalten.')) {
            replacePdfFileInput.value = '';
            currentReplacingDocId = null;
            return;
        }

        // Create FormData and upload
        const formData = new FormData();
        formData.append('file', file);

        const replaceUrl = `/viewer/api/replace/${currentReplacingDocId}`;

        fetch(replaceUrl, {
            method: 'POST',
            body: formData
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Fehler beim Ersetzen');
                    });
                }
                return response.json();
            })
            .then(data => {
                alert(`PDF erfolgreich ersetzt! Neue Seitenanzahl: ${data.page_count}`);
                // Reload page to reflect changes
                window.location.reload();
            })
            .catch(error => {
                console.error('Error replacing PDF:', error);
                alert(`Fehler beim Ersetzen des PDFs: ${error.message}`);
            })
            .finally(() => {
                replacePdfFileInput.value = '';
                currentReplacingDocId = null;
            });
    });

    // Delete document function
    window.deleteDocument = function(docId, filename) {
        // Confirm deletion
        if (!confirm(`Möchten Sie wirklich "${filename}" und alle zugehörigen Notizen löschen?\n\nDiese Aktion kann nicht rückgängig gemacht werden.`)) {
            return;
        }

        // Send DELETE request
        fetch(`/delete/${docId}`, {
            method: 'DELETE',
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Fehler beim Löschen');
                    });
                }
                return response.json();
            })
            .then(data => {
                // Show success message and reload page
                alert(data.message || 'Dokument erfolgreich gelöscht');
                window.location.reload();
            })
            .catch(error => {
                console.error('Error deleting document:', error);
                alert(`Fehler beim Löschen: ${error.message}`);
            });
    };
})();
</script>
{% endblock %}
